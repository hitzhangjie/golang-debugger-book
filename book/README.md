# 1 Go语言调试器开发

<img alt="封面图片" src="bookcover.jpeg" width="320px" />

## 1.1 作者简介

Hi，我是张杰，目前就职于腾讯（深圳）科技有限公司，后台开发高级工程师。在腾讯工作期间，曾先后从事Now直播后台、看点后台、信息流内容处理系统、QQ浏览器、三角洲行动等业务相关的工作，作为架构师+核心开发先后参与了微服务框架goneat、trpc的设计、开发，以及研发效能提升&团队落地、公司代码规范的制定+lint工具开发、工程素养培训、测试左移、职级晋升、代码评审等相关工作。

从高中毕业开始接触编程，到大学系统性学习，再到毕业参加工作至今，一转眼十年过去。计算机技术的发展始终吸引着我去学习、去思考、去探索更广阔的应用场景来丰富我们的现实生活。

开源让我接触了更大的世界，我很欣赏那种技术精湛、乐于分享甚至连指尖都洋溢着才华与天赋的工程师，并将这类人作为我的榜样。“在开源中学习，在开源中贡献”，写博客、写书、分享，也算是我践行这种理念的行动吧。

## 1.2 关于本书

计算机是个系统性工程，比如“一个程序是如何运行的”，看似简单的问题牵扯到了编程语言、编译器、链接器、操作系统、处理器、内存、总线控制等方方面面的内容，要掌握这些内容需要长时间的学习与实践。

我是从2016年开始了解go语言，2018年开始正式将其作为主力开发语言，期间还经历了些小插曲——对go的抵触。在深入了解c、cpp、java第三方协程库支持以及开发实践之后，最终认识到了go的优雅并决定掌握go。

学习go时，新手难免会遇到通过调试来认识语言细节的情况。delve是一款针对go语言的符号级调试器，在使用delve的过程中联想到可以从调试器角度切入来窥探计算机世界的秘密。不管是什么编程语言，只要有调试信息支持，总能借助调试器来窥探进程的运行过程。形象点的话可以联想下FPS游戏，一倍镜窥探代码执行，二倍镜窥探变量，三倍镜窥探类型系统，四倍镜窥探硬件特性……有什么能逃过调试器的法眼呢？

本书希望能从go调试器角度出发让开发者更好地理解go编程语言、编译器、链接器、操作系统、调试器、硬件之间的联系，这会比割裂似的课程教学更容易让读者认识到它们各自的价值以及彼此间密切的协作。开发者也将掌握调试器开发能力，从而可以开发一些针对语言级别的运行时分析、调试能力。

## 1.3 本书内容

调试过程，并不只是调试器的工作，也涉及到到了源码、编译器、链接器、调试信息标准，因此从（本书）调试器视角来看，它看到的是一连串的协作过程，可以给开发者更宏观的视角来审视软件开发的位置。

调试标准，调试信息格式有多种标准，了解它们的发展演进，可以更好地理解处理器、操作系统、编程语言等的设计思想，借助调试器还可以了解、验证某些语言特性的设计实现。

调试需要与操作系统交互来实现，调试给了一个更加直接、快速的途径让我们一窥操作系统的工作原理，如任务调度、信号处理、虚拟内存管理等。操作系统离我们那么近但是在认识上离我们又那么远，调试器依赖操作系统支持，也是个加深对操作系统认识的很好的契机。

此外，调试器是开发常用工具，本书除剖析调试器常用功能的设计实现、调试技巧，也能带读者领略调试信息标准的高屋建瓴的设计思想，站在巨人的肩膀上体验标准的美的一面。有资历的工程师可能认为他们不再需要调试器，但是这恰恰证明了调试器的强大，因为借助调试器的一次有效追根溯源过程，就可能将某一类“疑惑”给彻底终结，所以有资历的工程师才会认为“通常不需要调试器”。

业界已经有面向go语言的调试器了，如gdb、dlv等，我们从头再开发一款调试器的初衷并非只是为了新而新，而是希望以调试器为切入点，将相关知识进行融会贯通，这里的技术点涉及go语言本身（类型系统、协程调度）、编译器与调试器的协作（DWARF）、操作系统内核（虚拟内存、任务调度、系统调用、指令patch）以及处理器相关指令等等。

简言之，看似我们是在开发一个go语言调试器，实际上我们只是将它作为一个打开新世界大门的切入点，go初学者不仅可以从实际工程中学习上手go语言开发（涉及到命令行工具、网络服务器开发、系统级编程、深入理解go语言设计实现等），也能在循序渐进、拔高过程中慢慢体会操作系统、编译器、链接器、调试器、处理器之间的协作过程，从而加深对计算机系统全局的认识。

## 1.4 示例代码

**本书对应的示例代码，包括指令级调试器godbg、符号级调试器tinydbg、以及探索测试类代码golang-debugger-lessons：**

1. [**hitzhangjie/godbg**](https://github.com/hitzhangjie/godbg)，该项目提供了一个功能相对完整的 “**指令级调试器**” 实现，供读者测试、学习了解整体代码组织；
2. [**hitzhangjie/tinydbg**](https://github.com/hitzhangjie/tinydbg)，该项目提供了一个可用标准的 ”**符号级调试器**“ 实现，由 [dlv](https://github.com/go-delve/delve) 裁剪调整而来（剔除了与linux/amd64无关扩展，及高级功能）；
3. [**hitzhangjie/golang-debugger-lessons**](https://github.com/hitzhangjie/golang-debugger-lessons)，该项目按章节组织目录，每节实现目标在godbg、tinydbg落地前，会先在此项目中编写demo进行验证；

ps: [**hitzhangjie/godbg-debugger-lessons/0-godbg**](https://github.com/hitzhangjie/godbg)，该submodule即hitzhangjie/godbg。

**关于示例代码对应测试环境的一些补充说明**：

- godbg项目中提供了vscode的容器化开发配置 (详见./devcontainer/devcontainer.json)，指定的基础开发镜像是CentOS Stream9+go1.22.4。如果您更喜欢使用容器开发环境，您可以在vscode中安装插件 "Dev Conatiners"，在准备就绪后可以唤出Command Palette并选择 "Dev Containers: Reopen in Container"。
- 您也可以直接在Linux虚拟机或者Linux物理机中进行测试，请务必注意开发环境设置，Go版本必须>=go1.22并且<go1.25。
- 所有示例代码都是在linux/amd64平台架构下进行的测试，请您使用相同的环境进行测试。

> ps：关于上述Go版本约束的相关说明
>
> 1. Go版本不能低于go1.22：新版本才有的标准库函数旧版本无法正常编译，即使侥幸编译通过，实际产物也可能与书中内容描述有差异：
>    - go1.13将调试信息写入.zdebug_ sections，但go1.19不再写入.zdebug_ sections（写入的是.debug_ sections并通过flag指明是否开压缩）；
>    - go1.14引入SIGURG支持抢占，如果使用更古老的go版本测试，这些SIGURG处理相关的代码永远不会被触发，可能会影响读者阅读和理解。
>
> 2. Go版本必须低于go1.25：因为go1.25已经推进到了DWARF v5，而本书基于Go1.13~Go1.24编写，这期间Go工具链使用的是DWARF v4；

## 1.5 联系方式

如果您有任何建议，请提[Issues](https://github.com/hitzhangjie/golang-debugger-book/issues)，或邮件联系 `hit.zhangjie@gmail.com`，标题中注明来意 `GoDebugger交流`。

希望该书及相关示例，能顺利完成，也算是我磨练心性、自我提高的一种方式，如果能对大家确实起到帮助的作用那是再好不过了。借此机会，我也想向 go-delve/delve 的维护人员 [derekparker](https://github.com/derekparker)、[aarzilli](https://github.com/aarzilli) 以及其他贡献者致以诚挚的敬意，没有你们多年来的贡献、沉淀，我也没有什么好学习总结分享的。

如果喜欢本书，请点个 [Star](https://github.com/hitzhangjie/golang-debugger-book) 对作者予以支持 :)
