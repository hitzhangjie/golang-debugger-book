name: Auto Deploy GitBook

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      
    - name: Build and Deploy GitBook
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        tmpdir=$(mktemp -d)
        builddir=$(mktemp -d)
        
        # æ¸…ç†å‡½æ•°
        cleanup() {
          rm -rf "$tmpdir" 2>/dev/null || true
          rm -rf "$builddir" 2>/dev/null || true
        }
        trap cleanup EXIT
        
        echo "ğŸš€ Starting GitBook build and deployment..."
        
        # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨å¸¦tokençš„HTTPS URLï¼‰
        echo "ğŸ“¥ Cloning target repository..."
        git clone --depth 1 https://${{ secrets.DEPLOY_TOKEN }}@github.com/hitzhangjie/debugger101.io $tmpdir

        # ä½¿ç”¨Dockeræ„å»ºGitBook
        echo "ğŸ”¨ Building GitBook with Docker..."
        docker run --name gitbook --rm \
          -v ${PWD}:/root/gitbook \
          -v $builddir:$builddir \
          hitzhangjie/gitbook-cli:latest \
          bash -c "cd book && gitbook install && cd - && gitbook build book $builddir"
        
        # å¤åˆ¶æ„å»ºç»“æœåˆ°ç›®æ ‡ç›®å½•
        echo "ğŸ“‹ Copying build results..."
        cp -rf $builddir/* $tmpdir/
        
        # æäº¤æ›´æ”¹
        echo "ğŸ’¾ Committing changes..."
        cd $tmpdir
        git config --local user.name "hitzhangjie"
        git config --local user.email "hit.zhangjie@gmail.com"
        git add .
        git commit -m "Auto-deploy: $(date)"
        # ä½¿ç”¨ URL é‡å†™æ–¹å¼æ¨é€ï¼Œé¿å…å†™å…¥å‡­è¯æ–‡ä»¶
        git remote set-url origin https://${{ secrets.DEPLOY_TOKEN }}@github.com/hitzhangjie/debugger101.io
        git push -f -u origin master
        cd -
        
        echo "âœ… Deployment completed successfully!" 